<html>
<head>
    <style type="text/css">@charset "UTF-8";
    [ng\:cloak], [ng-cloak], [data-ng-cloak], [x-ng-cloak], .ng-cloak, .x-ng-cloak, .ng-hide:not(.ng-hide-animate) {
        display: none !important;
    }

    ng\:form {
        display: block;
    }

    .ng-animate-shim {
        visibility: hidden;
    }

    .ng-anchor {
        position: absolute;
    }

    browser-container {
        position: relative;
    }

    iframe {
        border: black 0px solid;
        width: 100%;
        height: 75%;
        overflow: visible;
    }
    #connection-status {
        font-family: 'San Francisco Display';
        font-weight: 400;
        font-style: normal;
        text-align: center;
    }
    </style>
    <meta content="text/html;charset=UTF-8" http-equiv="content-type">
    <meta content="A browser in your browser" name="description"/>
    <meta content="browser, js, browser.js, browserjs" name="keywords"/>
    <meta content="mailto:http:sha1:e82c7705fe2e57837193994642bc9f071bb8611c" name="microid">
    <meta content="user-scalable=0, initial-scale=1.0" name="viewport">
    <title>Browser.JS - Browsers in Browsers!</title>
    <link rel="stylesheet" media="all"
          href="application.css">
    <link href="https://fonts.s3.theom.nz/SanFrancisco.css" rel="stylesheet"/>
    <script src="service.js"></script>
    <script src="https://assets.s3.theom.nz/jquery.js"></script>
    <script>
        paceOptions = {
            ajax: false,
            document: false,
            eventLag: false
        }
    </script>
    <link rel="stylesheet" href="https://assets.s3.theom.nz/flash.css">
</head>
<body class="ng-scope">
<div id="connection-status">
    <div class="col-12">
        <div class="alert">
            <strong>Status: </strong><span id="updateState"></span> | <strong id="browserState">Ready</strong>
        </div>
    </div>
</div>
<div class="container-fluid ng-scope" ng-controller="mainController">
    <div id="slide-5" ng-if="currentSlide == 5" class="ng-scope" style="">
        <div class="search-instruction-and-illustration-wrapper">
            <div class="search-illustrator-wrapper">
                <div final-timing-delay="delayBeforeDone" search-illustrator="" user-click-prompt="Click Here"
                     class="ng-isolate-scope">
                    <div>
                        <browser-frame url="startingUrlTyping" class="ng-isolate-scope">
                            <div class="browser-frame">
                                <div class="browser-frame-top">
                                    <div class="browser-frame-top-row">
                                        <div class="browser-frame-top-left"></div>
                                        <div class="browser-frame-top-input">
                                            <div class="browser-frame-top-input-left"></div>
                                            <span class="browser-frame-top-input-url ng-binding" id="urlInput"
                                                  ng-bind="url">Not Connected</span>
                                            <div class="browser-frame-top-input-right"></div>
                                        </div>
                                        <div class="browser-frame-top-right"></div>
                                    </div>
                                </div>
                                <div class="browser-frame-content">
                                    <iframe name="browserjs" id="content-container" src=".iframe.html"></iframe>
                                </div>
                            </div>
                        </browser-frame>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function updateWebSocketStatus(socket){
        switch (socket.readyState){
            case 0:
                $('#browserState').html('Connecting...')
                return "<span style='color: blue'>CONNECTING</span>"
                break
            case 1:
                $('#browserState').html('Ready')
                return "<span style='color: limegreen'>CONNECTED</span>"
                break
            case 2:
                $('#browserState').html('Disconnecting')
                return "<span style='color: darkorange'>DISCONNECTING</span>"
                break
            case 3:
                $('#browserState').html('Disconnected')
                return "<span style='color: red'>DISCONNECTED</span>"
                break
        }
    }

    function addhttp(url) {
        if (!/^(?:f|ht)tps?\:\/\//.test(url)) {
            url = "http://" + url
        }
        return url
    }

    let current_base = ""
    let totalRequestCount = 0
    let requestCount = 0
    let paceStarted = false
    const SharedComms = new BroadcastChannel('comms')

    $(function () {
        window.WebSocket = window.WebSocket || window.MozWebSocket
        let socket = new WebSocket('ws://localhost:8000')

        let statusChange = setInterval(function(){
            if (socket.readyState === 3){
                clearInterval(statusChange)
            }
            $("#updateState").html(updateWebSocketStatus(socket))
        }, 100)

        socket.onopen = function () {
            socket.send(JSON.stringify({'type': 'init'}))
        }

        socket.onmessage = function (message) {
            context = JSON.parse(message.data)
            if (context.type === "displayContent") {
                doc = document.getElementById('content-container').contentDocument
                $(doc.documentElement).off('click')
                doc.documentElement.innerHTML = atob(context.html)
                $(doc.documentElement).on('click', 'a', function(e){
                    console.log('click')
                    e.preventDefault()
                    newBaseUrl = $(this).attr('href')
                    console.log(newBaseUrl)
                    if (newBaseUrl.substring(0, 7) === "http://" || newBaseUrl.substring(0, 8) === "https://") {
                        newBaseUrl = newBaseUrl
                    } else {
                        if (addhttp(newBaseUrl)[0] === "/"){
                            newBaseUrl = new URL(addhttp(current_base)).origin + newBaseUrl
                        } else if (newBaseUrl === ".." || newBaseUrl === "../" ) {
                            url = new URL(addhttp(current_base)).href
                            try {
                                newBaseUrl = new URL((url.slice(-1) === "/" ? url.split('/').slice(0, -2).join('/') : url.split('/').slice(0, -1).join('/')) + "/")
                                newBaseUrl = newBaseUrl.href
                            } catch(err) {
                                newBaseUrl = current_base
                            }
                        } else {
                            url = new URL(addhttp(current_base)).href
                            newBaseUrl = url.slice(-1) === "/" ? url + newBaseUrl : url + "/" + newBaseUrl
                        }
                    }
                    socket.send(JSON.stringify({'type': 'loadUri', 'uri': newBaseUrl}))
                    current_base = newBaseUrl
                    $('#browserState').html(`Loading...`)
                    navigator.serviceWorker.controller.postMessage(current_base)
                })
                $('.browser-frame-top-input-url').html(context.url)
            } else if (context.type === "rawContent"){
                SharedComms.postMessage(JSON.stringify({'content': context.content, 'contentType': context.contentType, 'uri': context.uri}))
                requestCount++
                $('#browserState').html(`Loading ${requestCount}/${totalRequestCount}`)
                if (requestCount === totalRequestCount){
                    totalRequestCount = 0
                    requestCount = 0
                    $('#browserState').html(`Ready`)
                }
            }
        }

        socket.onerror = function (error) {
            console.log('WebSocket error: ' + error)
        }

        SharedComms.onmessage = (event) => {
            console.log("Got load request")
            totalRequestCount++
            $('#browserState').html(`Loading ${requestCount}/${totalRequestCount}`)
            socket.send(JSON.stringify({'type': 'loadLibraryAsRaw', 'uri': event.data}))
        }

        $('.browser-frame-top-input-url').bind('click', function () {
            $(this).attr('contentEditable', true)
        }).keypress(function (e) {
            var key = e.which
            if (key == 13)  // the enter key code
            {
                $(this).attr('contentEditable', false)
                uri = $('#urlInput').text().trim()
                current_base = addhttp(uri)
                navigator.serviceWorker.controller.postMessage(current_base)
                socket.send(JSON.stringify({'type': 'loadUri', 'uri': addhttp(uri)}))
            }
        })
    })
</script>
</body>
</html>
